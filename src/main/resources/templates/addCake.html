<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Add Cake</title>
    <style>
        body{font-family:'Segoe UI',sans-serif;background:#fff7f0;margin:0}
        .wrap{max-width:760px;margin:40px auto;background:#fff0e6;padding:24px;border-radius:12px}
        .row{display:grid;grid-template-columns:180px 1fr;gap:12px;margin-bottom:12px}
        input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}
        button{background:#ff8c42;color:#fff;border:0;padding:10px 18px;border-radius:8px;cursor:pointer}
        .msg{margin:12px 0;font-weight:600;display:none}
        .msg.err{color:#c0392b}.msg.ok{color:#27ae60}
    </style>
</head>
<body>
<div class="wrap">
    <h2>Add a new cake</h2>

    <div id="msg" class="msg"></div>

    <div class="row"><label>Name</label><input id="name" required /></div>
    <div class="row"><label>Price</label><input id="price" type="number" step="0.01" required /></div>
    <div class="row"><label>Stock</label><input id="stock" type="number" required /></div>
    <div class="row"><label>Weight (kg)</label><input id="weight" type="number" step="0.01" /></div>

    <div class="row">
        <label>Category</label>
        <select id="categoryId"></select>
    </div>

    <div class="row"><label>Chef (name)</label><input id="chefName" type="text" placeholder="Pastry chef name (optional)" /></div>

    <div class="row"><label>Description</label><textarea id="description" rows="4" placeholder="Optional description"></textarea></div>

    <button onclick="submitCake()">Save</button>
</div>

<script>
    const $ = s => document.querySelector(s);

    function showMsg(text, ok=false){
      const el = $('#msg'); el.textContent = text;
      el.className = 'msg ' + (ok ? 'ok' : 'err'); el.style.display = 'block';
    }

    async function loadCategories(){
      const fill = cats => {
        const sel = $('#categoryId');
        if (!cats.length){ sel.innerHTML = '<option value="">No categories</option>'; sel.disabled = true; return; }
        sel.innerHTML = cats.map(c=>`<option value="${c.id}">${c.name ?? ('#'+c.id)}</option>`).join('');
      };
      try{
        let r = await fetch('/api/categories');
        if (!r.ok) r = await fetch('/api/categories/all');
        if (!r.ok) throw new Error('cannot load categories');
        const data = await r.json();
        const raw = Array.isArray(data) ? data
                  : Array.isArray(data?.content) ? data.content
                  : Array.isArray(data?.categories) ? data.categories
                  : [];
        const cats = raw.map(c => ({ id: c.id ?? c.categoryId ?? c.category_id, name: c.name ?? c.title ?? c.categoryName }));
        fill(cats);
      }catch(e){ showMsg('Failed to load categories: '+e.message); }
    }

    async function submitCake(){
      const token = localStorage.getItem('authToken');
      if (!token){ showMsg('Not logged in.'); return; }

      const weightVal = $('#weight').value.trim();
      const payload = {
        name:  $('#name').value.trim(),
        price: parseFloat($('#price').value),
        stock: parseInt($('#stock').value),
        weight: weightVal !== '' ? parseFloat(weightVal) : null,
        categoryId: parseInt($('#categoryId').value),
        pastryChefName: ($('#chefName').value || '').trim() || null,
        description: ($('#description').value || '').trim() || null
      };

      if (!payload.name || isNaN(payload.price) || isNaN(payload.stock) || isNaN(payload.categoryId)){
        showMsg('Please fill required fields.'); return;
      }

      try{
        const res = await fetch('/api/cakes', {
          method: 'POST',
          headers: { 'Content-Type':'application/json','Authorization':'Bearer '+token },
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          if (res.status===401) return showMsg('Unauthorized. Please login again.');
          if (res.status===403) return showMsg('Forbidden. Admins only.');
          return showMsg('Failed: '+await res.text());
        }
        const saved = await res.json();
        showMsg('Cake added: '+saved.name+' (id: '+saved.id+')', true);
        // window.location = '/home';
      }catch(e){ showMsg('Network error: '+e.message); }
    }

    loadCategories();
</script>
</body>
</html>
